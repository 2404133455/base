defvarp eventintime 0 250 $varidxmax
defvarp eventouttime 0 10000 $varidxmax
defvarp eventfadetime 0 500 $varidxmax
defvarp eventlines 0 6 $varidxmax
defvarp eventlinesopen 0 7 $varidxmax
deffvarp eventblend 0 1 1

ui_hud_events = [
    local event_texth
    uiclip 0 0 0 0 [uiclipforced 1; uitext "Dummy" $ui_texttiny [event_texth = $uilasth]]
    uivlist 0 [
        uistyle lefttop
        loopevents (- $eventlines) 0 event_id [
            local event_time; event_time = (geteventmillis $event_id)
            local event_millis; event_millis = (- $totalmillis $event_time)
            local event_blend; event_blend = $eventblend
            local event_growth; event_growth = 1.0
            caseif (&& $eventouttime (> $event_millis $eventouttime)) [
                local event_ctime; event_ctime = (- $event_millis $eventouttime)
                if (&& $eventfadetime (< $event_ctime $eventfadetime)) [
                    event_growth = (-f 1 (divf $event_ctime $eventfadetime))
                    event_blend = (clampf (*f $event_growth $eventblend) 0 1)
                ] [ event_blend = 0 ]
            ] (&& $eventintime (< $event_millis $eventintime)) [
                event_growth = (divf $event_millis $eventintime)
                event_blend = (clampf (*f $event_growth $eventblend) 0 1)
            ]
            if (>f $event_blend 0.0) [
                local event_clients; event_clients = (geteventtaggroups $event_id "client")
                local event_colour; event_colour = 0
                loopwhile event_clidx $event_clients [! $event_colour] [
                    event_clientid = (geteventtag $event_id "client" $event_clidx "clientnum")
                    if (= $focusedplayer $event_clientid) [ event_colour = 0xFF282810 ]
                ]
                local event_obj
                event_obj = [
                    uitext (geteventlist $event_id "args" "console") $ui_texttiny [
                        uistyle leftmiddle
                        uitextalign -1
                    ]
                ]
                local event_type; event_type = (geteventlist $event_id "this" "type")
                local event_action; event_action = (geteventlist $event_id "this" "action")
                if (= $showevents 2) [
                    cases $event_type "frag" [
                        event_obj = [
                            local event_self; event_self = (= (geteventtag $event_id "client" 0 "clientnum") (geteventtag $event_id "client" 1 "clientnum"))
                            local event_extra; event_extra = 0
                            loop event_attackid (- $event_clients 1) [
                                if $event_extra [
                                    uitext "+" $ui_texttiny [
                                        uistyle leftmiddle
                                        uitextalign -1
                                    ]
                                ]
                                uitext (geteventname $event_id "client" (+ $event_attackid 1) 3 0) $ui_texttiny [
                                    uistyle leftmiddle
                                    uitextalign -1
                                    if $event_extra [ uicolourscale 0xD0D0D0 ]
                                ]
                                event_extra = 1
                            ]
                            local event_weap; event_weap = (geteventlist $event_id "args" "weapon")
                            if (>= $event_weap 0) [
                                local event_weapon; event_weapon = (at $W_NAMES $event_weap)
                                uiimage (concatword "<rotate:4>" $[@[event_weapon]tex]) $[@[event_weapon]colour] 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                            ] [
                                if (geteventlist $event_id "args" "burning") [
                                    uiimage $burntex (getclientrescolour $focusedplayer $PULSE_BURN) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                ]
                                if (geteventlist $event_id "args" "bleeding") [
                                    uiimage $bleedtex (getclientrescolour $focusedplayer $PULSE_BLEED) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                ]
                                if (geteventlist $event_id "args" "shocking") [
                                    uiimage $shocktex (getclientrescolour $focusedplayer $PULSE_SHOCK) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                ]
                            ]
                            if $event_self [
                                uiimage $deadtex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                            ] [
                                if (&& (! (& $mutators (<< 1 $G_M_FFA))) (= (geteventtag $event_id "client" 0 "team") (geteventtag $event_id "client" 1 "team"))) [
                                    uiimage $warningtex (getclientrescolour $focusedplayer $PULSE_WARN) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                ]
                                uitext (geteventname $event_id "client" 0 3 0) $ui_texttiny [
                                    uistyle leftmiddle
                                    uitextalign -1
                                ]
                            ]
                        ]
                    ] "duel" [
                        if (! $event_colour) [ event_colour = 0xFF102828 ]
                        cases $event_action "start" [
                            event_obj = [
                                local event_extra; event_extra = 0
                                loop event_dueler $event_clients [
                                    if $event_extra [
                                        uiimage $modedueltex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                    ]
                                    uitext (geteventname $event_id "client" $event_dueler 3 0) $ui_texttiny [
                                        uistyle leftmiddle
                                        uitextalign -1
                                    ]
                                    event_extra = 1
                                ]
                                local event_round; event_round = (geteventlist $event_id "args" "round")
                                local event_desc; event_desc = (? (geteventlist $event_id "args" "sudden") "SUDDEN DEATH" (format "Round %1" $event_round))
                                uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uitext $event_desc $ui_texttiny [
                                    uistyle leftmiddle
                                    uitextalign -1
                                ]
                            ]
                        ]
                    ] "bomber" [
                        if (! $event_colour) [ event_colour = 0xFF102828 ]
                        cases $event_action "secure" [
                            event_obj = [
                                uitext (geteventname $event_id "client" 0 3 0) $ui_texttiny [
                                    uistyle leftmiddle
                                    uitextalign -1
                                ]
                                uiimage $bombtex (getclientrescolour $focusedplayer $PULSE_DISCO) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $bombtakentex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                            ]
                        ] "drop" [
                            event_obj = [
                                uitext (geteventname $event_id "client" 0 3 0) $ui_texttiny [
                                    uistyle leftmiddle
                                    uitextalign -1
                                ]
                                uiimage $bombtex (getclientrescolour $focusedplayer $PULSE_DISCO) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $bombdroptex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                            ]
                        ] "score" [
                            event_obj = [
                                local event_goal; event_goal = (geteventlist $event_id "args" "goal")
                                local event_team; event_team = (getbomberteam $event_goal)
                                uitext (geteventname $event_id "client" 0 3 0) $ui_texttiny [
                                    uistyle leftmiddle
                                    uitextalign -1
                                ]
                                uiimage $bombtex (getclientrescolour $focusedplayer $PULSE_DISCO) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $pointtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                            ]
                        ] "reset" [
                            event_obj = [
                                uiimage $bombtex (getclientrescolour $focusedplayer $PULSE_DISCO) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $pointtex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                            ]
                        ] "start" [
                            event_obj = [
                                uiimage $bombtex (getclientrescolour $focusedplayer $PULSE_DISCO) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $pointtex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                            ]
                        ]
                    ] "capture" [
                        if (! $event_colour) [ event_colour = 0xFF102828 ]
                        cases $event_action "secure" [
                            event_obj = [
                                local event_flag; event_flag = (geteventlist $event_id "args" "affinity")
                                local event_team; event_team = (getcaptureteam $event_flag)
                                uitext (geteventname $event_id "client" 0 3 0) $ui_texttiny [
                                    uistyle leftmiddle
                                    uitextalign -1
                                ]
                                uiimage $flagtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $flagtakentex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                            ]
                        ] "return" [
                            event_obj = [
                                local event_flag; event_flag = (geteventlist $event_id "args" "affinity")
                                local event_team; event_team = (getcaptureteam $event_flag)
                                uitext (geteventname $event_id "client" 0 3 0) $ui_texttiny [
                                    uistyle leftmiddle
                                    uitextalign -1
                                ]
                                uiimage $flagtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $pointtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                            ]
                        ] "drop" [
                            event_obj = [
                                local event_flag; event_flag = (geteventlist $event_id "args" "affinity")
                                local event_team; event_team = (getcaptureteam $event_flag)
                                uitext (geteventname $event_id "client" 0 3 0) $ui_texttiny [
                                    uistyle leftmiddle
                                    uitextalign -1
                                ]
                                uiimage $flagtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $flagdroptex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                            ]
                        ] "score" [
                            event_obj = [
                                local event_flag; event_flag = (geteventlist $event_id "args" "affinity")
                                local event_team; event_team = (getcaptureteam $event_flag)
                                local event_goal; event_goal = (geteventlist $event_id "args" "goal")
                                local event_base; event_base = (getcaptureteam $event_goal)
                                uitext (geteventname $event_id "client" 0 3 0) $ui_texttiny [
                                    uistyle leftmiddle
                                    uitextalign -1
                                ]
                                uiimage $flagtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $pointtex (getteamcolour $event_base) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                            ]
                        ] "reset" [
                            event_obj = [
                                local event_flag; event_flag = (geteventlist $event_id "args" "affinity")
                                local event_team; event_team = (getcaptureteam $event_flag)
                                uiimage $flagtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $pointtex (getteamcolour $event_team) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                            ]
                        ]
                    ] "defend" [
                        if (! $event_colour) [ event_colour = 0xFF102828 ]
                        if (|| (=s $event_action "secure") (=s $event_action "overthrow")) [
                            event_obj = [
                                local event_extra; event_extra = 0
                                loop event_attackid $event_clients [
                                    if (= (geteventtag $event_id "client" $event_attackid "team") (geteventlist $event_id "args" (? (=s $event_action "secure") "owner" "enemy"))) [
                                        if $event_extra [
                                            uitext "+" $ui_texttiny [
                                                uistyle leftmiddle
                                                uitextalign -1
                                            ]
                                        ]
                                        uitext (geteventname $event_id "client" $event_attackid 3 0) $ui_texttiny [
                                            uistyle leftmiddle
                                            uitextalign -1
                                        ]
                                        event_extra = 1
                                    ]
                                ]
                                uiimage $pointtex (getteamcolour (geteventlist $event_id "args" "oldowner")) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $arrowrighttex 0xFFFFFF 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uiimage $pointtex (getteamcolour (geteventlist $event_id "args" "owner")) 0 $event_texth $event_texth [ uistyle leftmiddle ]
                                uitext (getdefendname (geteventlist $event_id "args" "affinity")) $ui_texttiny [
                                    uistyle leftmiddle
                                    uitextalign -1
                                ]
                            ]
                        ]
                    ]
                ]
                uiclip 0 0 0 0 [
                    uistyle lefttop
                    uispace 0 $ui_padtiny [
                        uistyle lefttop
                        uiborderedimageclamped $skinalphatex (? $event_colour $event_colour 0xDD000000) 0 $ui_texborder $ui_screenborder 0 0 [
                            uistyle lefttop
                            local event_height
                            uispace $ui_padsmall $ui_padsmaller [
                                uistyle lefttop
                                uihlist $ui_padsmall [
                                    uistyle leftmiddle
                                    event_obj
                                ]
                            ]
                            uiprop [ uicolourblend $event_blend ]
                        ]
                    ]
                    event_height = (+f $ui_padsmaller $ui_padsmaller $uilasthprev)
                    uiclipsizeh (*f $event_height $event_growth)
                ]
            ]
        ]
    ]
]