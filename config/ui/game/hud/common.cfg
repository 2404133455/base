game_hud_recalc = [
    game_hud_panel_icon_width         = (*f (get game_hud_panel_width) 0.22)
    game_hud_panel_content_width      = (-f (get game_hud_panel_width) $game_hud_panel_icon_width)

    game_hud_player_effect_height     = (*f $game_hud_panel_content_width 0.067)

    game_hud_player_mainbar_width     = $game_hud_panel_content_width
    game_hud_player_mainbar_height    = (*f $game_hud_panel_content_width 0.08)
    game_hud_player_mainbar_text_size = (*f $game_hud_player_mainbar_height 50)

    game_hud_player_subbar_width      = (*f $game_hud_panel_content_width 0.8)
    game_hud_player_subbar_height     = (*f $game_hud_player_subbar_width 0.08)

    game_hud_largepanel_text_size     = (*f $game_hud_largepanel_width 2.5)

    game_hud_status_text_size         = (*f $game_hud_status_width 1.5)
]

deffvarp game_hud_panel_width 0.2 0.32 1.0 [
    game_hud_recalc
]

deffvarp game_hud_largepanel_width 0.2 0.6 1.0 [
    game_hud_recalc
]

deffvarp game_hud_status_width 0.2 0.6 1.0 [
    game_hud_recalc
]

game_hud_recalc

// 1:<affinity id>
game_hud_get_affinity_colour = [
    case $gamemode $G_CAPTURE [
        getteamcolour (getcaptureteam $arg1)
    ] $G_BOMBER [
        pulsecolour $PULSE_DISCO
    ]
]

game_hud_get_affinity_icon = [
    case $gamemode $G_CAPTURE [
        result $flagtex
    ] $G_BOMBER [
        result $bombtex
    ]
]

// 1:<affinity id>
game_hud_is_affinity_owned = [
    case $gamemode $G_CAPTURE [
        = (getcaptureowner $arg1) $ui_hud_focus
    ] $G_BOMBER [
        = (getbomberowner $arg1) $ui_hud_focus
    ]

]

game_hud_dyn_layout_props = [
    [ p_target ""   ]
    [ p_time   0    ]
    [ p_children [] ]
    [ p_start  0    ]
]

looplist _dyn_layout (getalias game_hud_dyn_layouts) [
    $_dyn_layout = []
]

game_hud_dyn_layouts = []

// 1:<target id>
game_hud_has_dyn_layout = [
    !=s (getalias (concatword $arg1 _object)) ""
]

// 1:<target id> 2:<time> 3:<children> 4:<remove cond> 5:<on remove>
game_hud_show_dyn_layout = [
    local _object_name
    _object_name = (concatword $arg1 _object)

    if (=s (getalias $_object_name) "") [
        $_object_name = [
            p_target    = @arg1
            p_time      = @arg2
            p_children  = [@@arg3]
            p_remove    = [@@arg4]
            p_on_remove = [@@arg5]
            p_pos       = [@@uilastsx @@uilastsy]
            p_size      = [@@uilastw @@uilasth]
            p_start     = @totalmillis
        ]

        append game_hud_dyn_layouts $_object_name
    ]
]

// 1:<layout id>
game_hud_remove_dyn_layout = [
    $arg1 = []

    game_hud_dyn_layouts = (listdel $game_hud_dyn_layouts $arg1)
]

// 1:<id>
game_hud_layout_target = [
    $arg1 = [
        @uilastsx
        @uilastsy
        @uilastw
        @uilasth
    ]
]

// 1:<layout> 2:<layout id>
ui_game_hud_dyn_layout = [
    @(props $game_hud_dyn_layout_props _dyn_layout)

    local _t _x _y _w _h
    _t = (smoothstep (-f 1 (clampf (divf (- $totalmillis $p_start) $p_time) 0 1)))
    _x = (lerpf (at $$p_target 0) (at $p_pos 0) $_t)
    _y = (lerpf (at $$p_target 1) (at $p_pos 1) $_t)
    _w = (lerpf (at $$p_target 2) (at $p_size 0) $_t)
    _h = (lerpf (at $$p_target 3) (at $p_size 1) $_t)

    uigroup [
        p_children

        uiposition $_x $_y
    ]

    if (p_remove) [
        p_on_remove
        game_hud_remove_dyn_layout $arg2
    ]
]

ui_game_hud_dyn_layouts = [
    looplist _dyn_layout $game_hud_dyn_layouts [
        ui_game_hud_dyn_layout $$_dyn_layout $_dyn_layout
    ]
]
