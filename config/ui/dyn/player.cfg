defvarp playerabovehealth 0 1 1
deffvarp playeraboveblend $fvaridxnonzero 1 1

dynui playerabove [
    uiallowinput 0
    uimenu 0
    uizindex -1 // draw behind other stuff on this surface
    uistyle centertop

    local player_presence
    player_presence = (&& (!= $uiarg1 $focusedplayer) (getclientpresence $uiarg1))
    if $player_presence [
        local player_state player_team player_colour player_opacity
        player_state = (getclientstate $uiarg1)
        player_team = (getclientteam $uiarg1)
        player_colour = (getclientcolour $uiarg1 $playerdisplaytone $playerdisplaytonelevel $playerdisplaytonemix)
        player_opacity = (*f (getclientopacity $uiarg1) (getdarkness $DARK_HALO))

        uivlist 0.00125 [
            uistyle centermiddle

            local player_health player_spawnhealth player_healthregen player_healthregenlast player_healthregenerating player_damagelevel player_damagecrit
            player_health = (getclienthealth $uiarg1)
            player_spawnhealth = (getclientspawnhealth $uiarg1)
            player_healthregen = (getclientregen $uiarg1)
            player_healthregenlast = (- $lastmillis $player_healthregen)
            player_healthregenerating = (<= $player_healthregenlast $regentime)
            player_buffing = (getclientbuffing $uiarg1)
            player_damagelevel = (clampf (? (= $player_state $CS_DEAD) 0.0 (divf $player_health $player_spawnhealth)) 0.0 1.0)
            player_damagecrit = (|| (= $player_state $CS_DEAD) (&& (= $player_state $CS_ALIVE) (<=f $player_damagelevel $damagecritical)))

            local player_bordercolour player_modtime
            player_bordercolour = (modcolour $player_colour 0.25)
            player_modtime = (divf (mod $lastmillis 1000) 500)
            if (>f $player_modtime 1.0) [ player_modtime = (-f 2.0 $player_modtime) ]

            if (= $player_state $CS_ALIVE) [
                caseif $player_damagecrit [
                    player_bordercolour = (skewcolour (modcolour (getclientrescolour $uiarg1 $PULSE_WARN) 0.75) $player_bordercolour $player_modtime)
                ] $player_buffing [
                    player_bordercolour = (skewcolour (modcolour (getclientrescolour $uiarg1 $PULSE_BUFF) 0.5) $player_bordercolour $player_modtime)
                ]
            ]

            if (|| (= $player_state $CS_DEAD) (= $player_state $CS_WAITING)) [
                uiimage $deadtex $player_colour 0 0.025 0.025 [
                    uistyle centermiddle
                    uiimageshadow 0.001 0x88010101
                    uicolourblend 0.65
                ]
            ] [
                if (&& $playerabovehealth (! (& $mutators (<< 1 $G_M_INSTAGIB)))) [
                    local player_healthcolour
                    player_healthcolour = (? (>f $player_damagelevel 1.0) (skewcolour $colourgreen $colourcyan (-f $player_damagelevel 1.0)) (skewcolour $colourred $colourgreen $player_damagelevel))
                    if $player_healthregenerating [
                        player_healthcolour = (skewcolour (getclientrescolour $uiarg1 $PULSE_REGEN) $player_healthcolour $player_modtime)
                    ]
                    uicolour $player_healthcolour (*f 0.02 $player_damagelevel) 0.002 [ uicolourblend 0.65 ]
                ]
            ]

            uiborderedimageclamped $skinshadowtex $player_bordercolour 0 $ui_texborder $ui_screenborder 0 0 [
                uicolourblend 0.5
                uispace 0.003 0.0 [
                    uifont $textfontoutline [ uitext (getclientname $uiarg1 0 0) 0.65 [ uicolourset $player_colour ] ]
                ]
            ]
        ]
        uipropagate [ uicolourblend (*f $playeraboveblend $player_opacity) ]
    ] [ hideui $uiname ]
]

dynui playeroverlay [
    uiallowinput 0
    uimenu 0
    uizindex -1 // draw behind other stuff on this surface
    uistyle centermiddle

    local player_presence
    player_presence = (&& (!= $uiarg1 $focusedplayer) (getclientpresence $uiarg1))
    if $player_presence [
        local player_opacity
        player_opacity = (*f (getclientopacity $uiarg1) (getdarkness 5))

        if (&& (= $gamemode $G_BOMBER) (= $uiarg1 (bombercurtarget))) [
            local player_effect player_offset
            player_effect = (absf (-f 1 (divf (mod $lastmillis 500) 250)))
            player_offset = (+f 0.085 (*f 0.015 $player_effect))
            uiimage "textures/hud/indicator" (skewcolour 0xFFFFFF (pulsecolour $PULSE_WARN) $player_effect) 0 $player_offset $player_offset [
                uistyle centermiddle
                uiimageshadow 0.001 0x88010101
                uiimage "textures/icons/bomb" (pulsecolour $PULSE_DISCO) 0 0.02 0.02 [
                    uistyle lefttop
                    uiimageshadow 0.001 (modcolour (pulsecolour $PULSE_DISCO) 0.25)
                ]
            ]
        ]
        uipropagate [ uicolourblend (*f $playeraboveblend $player_opacity) ]
    ] [ hideui $uiname ]
]